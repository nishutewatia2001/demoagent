<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zero-Key Trip &amp; Task Planner</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", Tahoma, sans-serif;
      }
      body {
        margin: 0;
        padding: 2rem;
        background: radial-gradient(circle at top, #eef3ff, #ffffff);
      }
      h1 {
        margin-top: 0;
        color: #1f2933;
      }
      form {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 12px 30px rgba(31, 41, 51, 0.1);
        margin-bottom: 2rem;
      }
      label {
        display: flex;
        flex-direction: column;
        font-size: 0.9rem;
        color: #243b53;
      }
      input,
      select {
        margin-top: 0.4rem;
        padding: 0.55rem 0.75rem;
        border-radius: 8px;
        border: 1px solid rgba(104, 112, 118, 0.35);
        font-size: 0.95rem;
      }
      button {
        grid-column: 1 / -1;
        padding: 0.85rem 1.4rem;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
      }
      button:hover {
        opacity: 0.95;
      }
      .results {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 12px 30px rgba(31, 41, 51, 0.1);
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.15);
        color: #1f2937;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .error {
        color: #b91c1c;
        font-weight: 600;
      }
      .grid {
        display: grid;
        gap: 1rem;
      }
      ul {
        padding-left: 1.2rem;
      }
      article {
        padding: 0.85rem;
        border-radius: 10px;
        background: rgba(99, 102, 241, 0.08);
      }
      details {
        margin-top: 0.75rem;
      }
      @media (max-width: 720px) {
        body {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <h1>Zero-Key Trip &amp; Task Planner</h1>
    <form id="planner-form">
      <label>
        User ID
        <input name="user_id" type="text" value="web-user" required />
      </label>
      <label>
        City
        <input name="city" type="text" value="Bengaluru" required />
      </label>
      <label>
        Start date
        <input name="start_date" type="date" required />
      </label>
      <label>
        Duration (days)
        <input name="duration_days" type="number" min="1" max="7" value="1" required />
      </label>
      <label>
        Pace
        <select name="pace">
          <option value="relaxed">Relaxed</option>
          <option value="balanced" selected>Balanced</option>
          <option value="packed">Packed</option>
        </select>
      </label>
      <label>
        Budget
        <select name="budget">
          <option value="low">Low</option>
          <option value="mid" selected>Mid</option>
          <option value="high">High</option>
        </select>
      </label>
      <label>
        Latitude (optional)
        <input name="lat" type="text" value="12.9716" />
      </label>
      <label>
        Longitude (optional)
        <input name="lon" type="text" value="77.5946" />
      </label>
      <button type="submit">Generate itinerary</button>
    </form>

    <div id="status" aria-live="polite"></div>
    <div id="results" class="results" hidden>
      <section>
        <h2>Evaluation</h2>
        <div class="badge" id="score"></div>
        <p id="pass-status"></p>
        <details id="rules" hidden>
          <summary>Rubric details</summary>
          <ul id="rules-list"></ul>
        </details>
        <p id="weather"></p>
        <p id="artifact"></p>
      </section>
      <section>
        <h2>Schedule</h2>
        <div id="schedule" class="grid"></div>
      </section>
      <section>
        <h2>Points of Interest</h2>
        <ul id="stops"></ul>
      </section>
      <section>
        <h2>Packing &amp; Tasks</h2>
        <h3>Packing</h3>
        <ul id="packing"></ul>
        <h3>Tasks</h3>
        <ul id="tasks"></ul>
      </section>
    </div>

    <script>
      const form = document.getElementById("planner-form");
      const statusBox = document.getElementById("status");
      const results = document.getElementById("results");
      const score = document.getElementById("score");
      const passStatus = document.getElementById("pass-status");
      const rulesDetails = document.getElementById("rules");
      const rulesList = document.getElementById("rules-list");
      const weather = document.getElementById("weather");
      const artifact = document.getElementById("artifact");
      const schedule = document.getElementById("schedule");
      const stops = document.getElementById("stops");
      const packing = document.getElementById("packing");
      const tasks = document.getElementById("tasks");

      form.start_date.valueAsDate = new Date();

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        results.hidden = true;
        statusBox.textContent = "Running planner...";

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "Request failed");
          }
          const data = await response.json();
          renderResults(data);
          statusBox.textContent = "";
        } catch (error) {
          statusBox.textContent = `Error: ${error.message}`;
        }
      });

      function renderResults(data) {
        if (data.error) {
          statusBox.textContent = `Error: ${data.error}`;
          return;
        }

        results.hidden = false;
        const evaluation = data.evaluation || {};
        score.textContent = `Score ${evaluation.score || 0} / ${evaluation.max || 0}`;
        if (data.passed) {
          passStatus.textContent = "✅ Plan passed the rubric.";
          passStatus.classList.remove("error");
        } else {
          passStatus.textContent = "⚠️ Plan needs refinement.";
          passStatus.classList.add("error");
        }

        const rules = evaluation.rules || {};
        rulesList.innerHTML = "";
        Object.entries(rules).forEach(([rule, ok]) => {
          const li = document.createElement("li");
          li.textContent = `${rule.replace(/_/g, " ")} – ${ok ? "✅" : "❌"}`;
          rulesList.appendChild(li);
        });
        rulesDetails.hidden = Object.keys(rules).length === 0;

        const plan = data.plan || {};
        weather.textContent = plan.weather_note ? `Weather: ${plan.weather_note}` : "";
        artifact.textContent = data.artifact_path ? `Saved file: ${data.artifact_path}` : "";

        schedule.innerHTML = "";
        (plan.schedule || []).forEach((day) => {
          const article = document.createElement("article");
          const heading = document.createElement("h3");
          heading.textContent = `${day.date} – ${day.city}`;
          heading.style.marginTop = "0";
          article.appendChild(heading);
          const list = document.createElement("ol");
          (day.segments || []).forEach((segment) => {
            const li = document.createElement("li");
            const summary = segment.summary ? `\n${segment.summary}` : "";
            li.innerHTML = `<strong>${segment.slot}:</strong> ${segment.activity}${summary ? `<br /><small>${segment.summary}</small>` : ""}`;
            list.appendChild(li);
          });
          article.appendChild(list);
          schedule.appendChild(article);
        });

        stops.innerHTML = "";
        (plan.stops || []).forEach((stop) => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${stop.title}</strong> – ${stop.summary || ""}`;
          stops.appendChild(li);
        });

        packing.innerHTML = "";
        (plan.checklist?.packing || []).forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          packing.appendChild(li);
        });

        tasks.innerHTML = "";
        (plan.checklist?.tasks || []).forEach((task) => {
          const li = document.createElement("li");
          li.textContent = task;
          tasks.appendChild(li);
        });
      }
    </script>
  </body>
</html>
